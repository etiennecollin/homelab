---
services:
  authelia:
    image: "authelia/authelia:4.39.14"
    container_name: "authelia"
    restart: "unless-stopped"
    depends_on:
      authelia-redis:
        condition: "service_started"
    volumes:
      - "./config/authelia:/config"
      - "./config/secrets:/secrets:ro"
    environment:
      PUID: "${PUID}"
      PGID: "${PGID}"
      TZ: "${TIMEZONE}"
      DOMAIN: "${DOMAIN}"
      AUTH_NETWORK: "${AUTH_NETWORK}"
      PROXY_NETWORK: "${PROXY_NETWORK}"
      MAIN_NETWORK: "${MAIN_NETWORK}"
      X_AUTHELIA_CONFIG_FILTERS: "template"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.${DOMAIN}`)"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      - "traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/authz/forward-auth"
      - "traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Email,Remote-Name"
    networks:
      - "proxy"
      - "auth"

  authelia-redis:
    image: "redis:alpine"
    container_name: "authelia-redis"
    restart: "unless-stopped"
    volumes:
      - "./config/redis:/data"
    environment:
      TZ: "${TIMEZONE}"
    networks:
      - "auth"

networks:
  proxy:
    external: "true"
  auth:
    name: "auth"
    driver: "bridge"
    ipam:
      config:
        - subnet: "${AUTH_NETWORK}"
