services:
  vaultwarden:
    image: "vaultwarden/server:1.34.1"
    container_name: "vaultwarden"
    restart: "unless-stopped"
    environment:
      DOMAIN: "https://vaultwarden.${DOMAIN}"
      SIGNUPS_ALLOWED: "false"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "./config:/data"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.${DOMAIN}`)"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"
    networks:
      - "proxy"

  backup:
    image: "ttionya/vaultwarden-backup:1.24.3"
    container_name: "vaultwarden-backup"
    restart: "unless-stopped"
    depends_on:
      vaultwarden:
        condition: "service_started"
    environment:
      RCLONE_REMOTE_NAME: "VaultwardenBackup"
      RCLONE_REMOTE_DIR: "/VaultwardenBackup/"
      CRON: "5 * * * *"
      ZIP_ENABLE: "TRUE"
      ZIP_TYPE: "7z"
      BACKUP_FILE_SUFFIX: "%Y%m%d"
      BACKUP_KEEP_DAYS: 0 # Keep all
      # PING_URL_WHEN_SUCCESS: "https://ntfy.${DOMAIN}/main"
      # PING_URL_WHEN_SUCCESS_CURL_OPTIONS: '-L -H "Title: %{subject}" -H "Priority: default" -H "Tags: white_check_mark" -d "%{content}"'
      PING_URL_WHEN_FAILURE: "https://ntfy.${DOMAIN}/main"
      PING_URL_WHEN_FAILURE_CURL_OPTIONS: '-L -H "Title: %{subject}" -H "Priority: max" -H "Tags: warning" -d "%{content}"'
      TIMEZONE: "${TIMEZONE}"
    env_file:
      - "./secret.env"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "./config:/bitwarden/data/"
      - "vaultwarden-rclone-data:/config/"
    networks:
      - "proxy"

volumes:
  vaultwarden-rclone-data:
    external: "true"
    name: "vaultwarden-rclone-data"

networks:
  proxy:
    external: "true"
