services:
  vaultwarden:
    image: "vaultwarden/server:latest"
    container_name: "vaultwarden"
    restart: "unless-stopped"
    environment:
      DOMAIN: "https://vaultwarden.${DOMAIN}"
      SIGNUPS_ALLOWED: "false"
    volumes:
      - "./config:/data"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.${DOMAIN}`)"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"
    networks:
      - "proxy"

  backup:
    image: "ttionya/vaultwarden-backup:latest"
    container_name: "vaultwarden-backup"
    restart: "unless-stopped"
    environment:
      RCLONE_REMOTE_NAME: "VaultwardenBackup"
      RCLONE_REMOTE_DIR: "/VaultwardenBackup/"
      CRON: "5 * * * *"
      ZIP_ENABLE: "TRUE"
      ZIP_TYPE: "7z"
      BACKUP_FILE_SUFFIX: "%Y%m%d"
      BACKUP_KEEP_DAYS: 0 # Keep all
      # PING_URL: ""
      # PING_URL_WHEN_START: ""
      # PING_URL_WHEN_SUCCESS: ""
      # PING_URL_WHEN_FAILURE: ""
      TIMEZONE: "Canada/Eastern"
    env_file:
      - "./secret.env"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "./config:/bitwarden/data/"
      - "vaultwarden-rclone-data:/config/"
    networks:
      - "proxy"

volumes:
  vaultwarden-rclone-data:
    external: "true"
    name: "vaultwarden-rclone-data"

networks:
  proxy:
    external: "true"
